<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnimeTime - Calculadora de Maratona</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .anime-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-size: cover;
            background-position: center;
            opacity: 0.15;
            transition: background-image 0.5s ease-in-out;
        }
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #6366f1;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #475569; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6366f1; 
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- Background Image Container -->
    <div id="bg-container" class="anime-bg" style="background-image: url('https://wallpaperaccess.com/full/19934.jpg');"></div>

    <!-- Main Container -->
    <div class="w-full max-w-4xl p-4 md:p-8 z-10">
        
        <!-- Header -->
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-400 mb-2">
                <i class="fas fa-clock mr-2"></i>AnimeTime
            </h1>
            <p class="text-slate-400">Descubra quanto tempo falta para terminar seu anime favorito.</p>
        </header>

        <!-- Search Section -->
        <div id="search-section" class="w-full max-w-xl mx-auto transition-all duration-300">
            <div class="relative group">
                <div class="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-cyan-500 rounded-lg blur opacity-30 group-hover:opacity-75 transition duration-200"></div>
                <div class="relative flex items-center bg-slate-800 rounded-lg p-1">
                    <i class="fas fa-search text-slate-400 ml-3"></i>
                    <input type="text" id="anime-search" 
                        class="w-full bg-transparent text-white p-3 focus:outline-none placeholder-slate-500" 
                        placeholder="Digite o nome do anime (ex: One Piece)..."
                        autocomplete="off">
                    <div id="search-loader" class="loader mr-3 hidden"></div>
                </div>
            </div>

            <!-- Search Results Dropdown -->
            <div id="search-results" class="hidden mt-2 bg-slate-800 rounded-lg shadow-xl border border-slate-700 max-h-60 overflow-y-auto absolute w-full max-w-xl z-50">
                <!-- Results injected via JS -->
            </div>
        </div>

        <!-- Calculator Section (Hidden initially) -->
        <div id="calculator-section" class="hidden mt-8 grid grid-cols-1 md:grid-cols-3 gap-6 animate-fade-in-up">
            
            <!-- Left: Anime Info -->
            <div class="md:col-span-1 glass-panel rounded-2xl p-6 flex flex-col items-center text-center h-fit shadow-lg">
                <img id="anime-cover" src="" alt="Cover" class="w-48 rounded-lg shadow-2xl mb-4 border-2 border-indigo-500/30">
                <h2 id="anime-title" class="text-xl font-bold text-white mb-2 leading-tight">Anime Title</h2>
                <div class="flex flex-wrap justify-center gap-2 mb-4">
                    <span id="anime-status" class="px-2 py-1 text-xs rounded-full bg-green-500/20 text-green-400 font-semibold border border-green-500/30">Airing</span>
                    <span id="anime-total-eps" class="px-2 py-1 text-xs rounded-full bg-blue-500/20 text-blue-400 font-semibold border border-blue-500/30">? Eps</span>
                </div>
                <button onclick="resetApp()" class="text-sm text-slate-400 hover:text-white underline decoration-dotted mt-2">
                    <i class="fas fa-arrow-left mr-1"></i> Escolher outro
                </button>
            </div>

            <!-- Right: Controls & Stats -->
            <div class="md:col-span-2 space-y-6">
                
                <!-- Controls Card -->
                <div class="glass-panel rounded-2xl p-6">
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-slate-300 mb-2 flex justify-between">
                            <span>Episódio Atual:</span>
                            <span id="current-ep-display" class="text-indigo-400 font-bold">0</span>
                        </label>
                        <input type="range" id="ep-slider" min="0" max="1000" value="0" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-indigo-500">
                        <div class="flex justify-between text-xs text-slate-500 mt-1">
                            <span>0</span>
                            <span id="slider-max-display">Wait...</span>
                        </div>
                        <input type="number" id="ep-input" class="mt-3 w-full bg-slate-900/50 border border-slate-700 rounded p-2 text-center text-white focus:border-indigo-500 focus:outline-none" placeholder="Ou digite o número aqui">
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Filler Toggle -->
                        <div class="flex items-center justify-between bg-slate-800/50 p-3 rounded-lg border border-slate-700/50">
                            <div class="flex flex-col">
                                <span class="text-sm font-medium text-white"><i class="fas fa-trash-alt mr-2 text-pink-400"></i>Pular Fillers?</span>
                                <span class="text-xs text-slate-400" id="filler-status-text">Não detectado</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="filler-toggle" class="sr-only peer" disabled>
                                <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-pink-500"></div>
                            </label>
                        </div>

                        <!-- Speed Toggle -->
                        <div class="flex items-center justify-between bg-slate-800/50 p-3 rounded-lg border border-slate-700/50">
                            <div class="flex flex-col">
                                <span class="text-sm font-medium text-white"><i class="fas fa-forward mr-2 text-yellow-400"></i>Pular Opening?</span>
                                <span class="text-xs text-slate-400">~20min/ep</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="skip-op-toggle" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-yellow-500"></div>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Daily Pace -->
                    <div class="mt-4 pt-4 border-t border-slate-700/50">
                        <label class="block text-xs font-medium text-slate-400 mb-1">Ritmo Diário (Eps por dia):</label>
                        <div class="flex items-center gap-3">
                            <input type="range" id="pace-slider" min="1" max="20" value="3" class="w-full h-1 bg-slate-700 rounded-lg cursor-pointer accent-cyan-500">
                            <span id="pace-display" class="bg-slate-800 px-3 py-1 rounded border border-slate-600 font-mono text-cyan-400">3</span>
                        </div>
                    </div>
                </div>

                <!-- Stats Result -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass-panel p-4 rounded-xl border-l-4 border-indigo-500">
                        <p class="text-xs text-slate-400 uppercase tracking-wider mb-1">Faltam</p>
                        <p class="text-2xl font-bold text-white"><span id="res-eps">0</span> <span class="text-sm font-normal text-slate-400">episódios</span></p>
                    </div>
                    <div class="glass-panel p-4 rounded-xl border-l-4 border-cyan-500">
                        <p class="text-xs text-slate-400 uppercase tracking-wider mb-1">Tempo Total</p>
                        <p class="text-2xl font-bold text-white"><span id="res-hours">0</span> <span class="text-sm font-normal text-slate-400">horas</span></p>
                        <p class="text-xs text-slate-500 mt-1" id="res-days-raw">(~0 dias seguidos)</p>
                    </div>
                </div>

                <!-- Big Final Result -->
                <div class="bg-gradient-to-r from-indigo-600 to-cyan-600 rounded-xl p-5 shadow-lg transform transition hover:scale-[1.01]">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-indigo-100 text-sm font-medium mb-1"><i class="fas fa-calendar-check mr-2"></i>Estimativa de Conclusão</p>
                            <h3 class="text-3xl font-bold text-white mb-1" id="res-date-end">...</h3>
                            <p class="text-xs text-indigo-200" id="res-desc-pace">Assistindo 3 eps por dia</p>
                        </div>
                        <div class="bg-white/10 p-2 rounded-lg backdrop-blur-sm">
                            <i class="fas fa-flag-checkered text-2xl text-white"></i>
                        </div>
                    </div>
                    <div id="filler-saved-msg" class="hidden mt-3 text-xs bg-black/20 p-2 rounded text-pink-100 border border-pink-400/30">
                        <i class="fas fa-magic mr-1"></i> Você economizou <span class="font-bold" id="saved-hours">0</span> horas pulando fillers!
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Script -->
    <script>
        // --- State ---
        let currentAnime = null;
        let fillerData = []; // Ranges like [[1,5], [10,12]]
        let hasFillerData = false;
        
        // --- DOM Elements ---
        const searchInput = document.getElementById('anime-search');
        const searchLoader = document.getElementById('search-loader');
        const searchResults = document.getElementById('search-results');
        const calculatorSection = document.getElementById('calculator-section');
        const searchSection = document.getElementById('search-section');
        const bgContainer = document.getElementById('bg-container');
        
        // Inputs
        const epSlider = document.getElementById('ep-slider');
        const epInput = document.getElementById('ep-input');
        const paceSlider = document.getElementById('pace-slider');
        const fillerToggle = document.getElementById('filler-toggle');
        const skipOpToggle = document.getElementById('skip-op-toggle');

        // Displays
        const currentEpDisplay = document.getElementById('current-ep-display');
        const sliderMaxDisplay = document.getElementById('slider-max-display');
        const paceDisplay = document.getElementById('pace-display');
        
        // Results
        const resEps = document.getElementById('res-eps');
        const resHours = document.getElementById('res-hours');
        const resDaysRaw = document.getElementById('res-days-raw');
        const resDateEnd = document.getElementById('res-date-end');
        const resDescPace = document.getElementById('res-desc-pace');
        const fillerSavedMsg = document.getElementById('filler-saved-msg');
        const savedHoursDisplay = document.getElementById('saved-hours');

        // --- Filler Database (Hardcoded for Demo) ---
        // Format: Ranges of fillers [start, end] inclusive
        const FILLER_DB = {
            'One Piece': [[54,61], [98,99], [102,102], [131,143], [196,206], [220,225], [227,228], [279,283], [291,292], [303,303], [317,319], [326,336], [382,384], [406,407], [426,429], [457,458], [492,492], [542,542], [575,578], [590,590], [626,628], [747,750], [780,782], [807,807], [881,881], [895,896], [907,907], [1029,1030]],
            'Naruto': [[26,26], [97,97], [101,106], [136,140], [143,219]],
            'Naruto: Shippuuden': [[28,28], [57,71], [90,112], [144,151], [170,171], [176,196], [223,242], [257,260], [271,271], [279,281], [284,289], [290,295], [303,320], [347,361], [376,377], [388,390], [394,413], [416,416], [422,423], [427,450], [464,469], [480,483]],
            'Bleach': [[33,33], [50,50], [64,109], [128,137], [168,189], [204,205], [213,214], [227,266], [287,287], [298,299], [303,305], [311,342], [355,355]]
        };

        // --- Search Logic ---
        let debounceTimer;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            const query = e.target.value;
            
            if(query.length < 3) {
                searchResults.classList.add('hidden');
                return;
            }

            searchLoader.classList.remove('hidden');
            
            debounceTimer = setTimeout(() => {
                fetchAnime(query);
            }, 600);
        });

        async function fetchAnime(query) {
            try {
                const response = await fetch(`https://api.jikan.moe/v4/anime?q=${query}&limit=5`);
                const data = await response.json();
                renderResults(data.data);
            } catch (error) {
                console.error("API Error", error);
            } finally {
                searchLoader.classList.add('hidden');
            }
        }

        function renderResults(animes) {
            searchResults.innerHTML = '';
            if(!animes || animes.length === 0) {
                searchResults.classList.add('hidden');
                return;
            }

            animes.forEach(anime => {
                const div = document.createElement('div');
                div.className = 'flex items-center p-3 hover:bg-slate-700 cursor-pointer border-b border-slate-700 last:border-0 transition';
                div.innerHTML = `
                    <img src="${anime.images.jpg.small_image_url}" class="w-10 h-14 object-cover rounded mr-3">
                    <div>
                        <div class="font-bold text-sm text-white">${anime.title}</div>
                        <div class="text-xs text-slate-400">${anime.type} • ${anime.episodes || '?'} eps</div>
                    </div>
                `;
                div.onclick = () => selectAnime(anime);
                searchResults.appendChild(div);
            });
            searchResults.classList.remove('hidden');
        }

        function selectAnime(anime) {
            currentAnime = anime;
            
            // Check for hardcoded fillers
            const commonName = Object.keys(FILLER_DB).find(key => anime.title.includes(key));
            if (commonName) {
                fillerData = FILLER_DB[commonName];
                hasFillerData = true;
                document.getElementById('filler-status-text').innerText = `Disponível (${commonName})`;
                document.getElementById('filler-status-text').className = "text-xs text-green-400";
                fillerToggle.disabled = false;
            } else {
                fillerData = [];
                hasFillerData = false;
                document.getElementById('filler-status-text').innerText = "Indisponível para este anime";
                document.getElementById('filler-status-text').className = "text-xs text-slate-500";
                fillerToggle.disabled = true;
                fillerToggle.checked = false;
            }

            // Update UI
            document.getElementById('anime-title').innerText = anime.title;
            document.getElementById('anime-cover').src = anime.images.jpg.large_image_url;
            document.getElementById('anime-status').innerText = anime.status;
            
            // Set Max Episodes
            const maxEps = anime.episodes || 1120; // Default fallback for ongoing huge animes if API returns null
            document.getElementById('anime-total-eps').innerText = `${maxEps} Eps`;
            
            epSlider.max = maxEps;
            epSlider.value = 0;
            epInput.value = 0;
            sliderMaxDisplay.innerText = maxEps;
            
            // Set Background
            bgContainer.style.backgroundImage = `url('${anime.images.jpg.large_image_url}')`;

            // Transitions
            searchSection.classList.add('hidden');
            searchResults.classList.add('hidden');
            searchInput.value = '';
            calculatorSection.classList.remove('hidden');

            calculate();
        }

        function resetApp() {
            calculatorSection.classList.add('hidden');
            searchSection.classList.remove('hidden');
            currentAnime = null;
            bgContainer.style.backgroundImage = "url('https://wallpaperaccess.com/full/19934.jpg')";
        }

        // --- Calculation Logic ---

        function isFiller(epNum) {
            if (!hasFillerData) return false;
            for (let range of fillerData) {
                if (epNum >= range[0] && epNum <= range[1]) return true;
            }
            return false;
        }

        function calculate() {
            if (!currentAnime) return;

            const totalEps = parseInt(epSlider.max);
            const currentEp = parseInt(epSlider.value);
            const pace = parseInt(paceSlider.value);
            const skipFillers = fillerToggle.checked && hasFillerData;
            const skipOp = skipOpToggle.checked;

            let remainingEpsCount = 0;
            let fillersSkippedCount = 0;

            // Iterate from current next ep to total to count accurately
            for (let i = currentEp + 1; i <= totalEps; i++) {
                if (skipFillers && isFiller(i)) {
                    fillersSkippedCount++;
                    continue;
                }
                remainingEpsCount++;
            }

            // Time Math
            const minutesPerEp = skipOp ? 20 : 24;
            const totalMinutes = remainingEpsCount * minutesPerEp;
            const totalHours = Math.floor(totalMinutes / 60);
            
            // Binge Days (Raw 24h)
            const daysRaw = (totalHours / 24).toFixed(1);

            // Real Days (Pace)
            const daysToFinish = Math.ceil(remainingEpsCount / pace);
            
            // Date Calculation
            const today = new Date();
            const endDate = new Date();
            endDate.setDate(today.getDate() + daysToFinish);
            
            const options = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
            const dateString = endDate.toLocaleDateString('pt-BR', options);

            // Render
            resEps.innerText = remainingEpsCount;
            resHours.innerText = totalHours;
            resDaysRaw.innerText = `(${daysRaw} dias ininterruptos)`;
            resDateEnd.innerText = (remainingEpsCount === 0) ? "Concluído!" : dateString;
            resDescPace.innerText = (remainingEpsCount === 0) ? "Parabéns, otaku!" : `Assistindo ${pace} eps por dia`;

            // Filler Savings UI
            if (skipFillers && fillersSkippedCount > 0) {
                const savedMins = fillersSkippedCount * minutesPerEp;
                const savedHrs = (savedMins / 60).toFixed(1);
                savedHoursDisplay.innerText = savedHrs;
                fillerSavedMsg.classList.remove('hidden');
            } else {
                fillerSavedMsg.classList.add('hidden');
            }
        }

        // --- Event Listeners ---
        
        epSlider.addEventListener('input', (e) => {
            epInput.value = e.target.value;
            currentEpDisplay.innerText = e.target.value;
            calculate();
        });

        epInput.addEventListener('input', (e) => {
            let val = parseInt(e.target.value);
            if (val > epSlider.max) val = epSlider.max;
            if (val < 0) val = 0;
            epSlider.value = val;
            currentEpDisplay.innerText = val || 0;
            calculate();
        });

        paceSlider.addEventListener('input', (e) => {
            paceDisplay.innerText = e.target.value;
            calculate();
        });

        fillerToggle.addEventListener('change', calculate);
        skipOpToggle.addEventListener('change', calculate);

    </script>
</body>
</html>