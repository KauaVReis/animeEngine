<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANIME.STACK // v3.2 Search Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Space+Grotesk:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'display': ['"Archivo Black"', 'sans-serif'],
                        'body': ['"Space Grotesk"', 'sans-serif'],
                    },
                    colors: {
                        'neo-yellow': '#FBbf24',
                        'neo-purple': '#a855f7',
                        'neo-pink': '#ec4899',
                        'neo-bg': '#f0f0f0',
                        'neo-black': '#121212',
                        'neo-blue': '#3b82f6',
                        'neo-green': '#22c55e',
                    },
                    boxShadow: {
                        'neo': '5px 5px 0px 0px #000000',
                        'neo-hover': '2px 2px 0px 0px #000000',
                        'neo-deep': '8px 8px 0px 0px #000000',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #e0e7ff;
            background-image: radial-gradient(#a5b4fc 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
       .neo-box {
            background-color: white;
            border: 3px solid black;
            box-shadow: 6px 6px 0px 0px black;
            transition: all 0.1s ease-in-out;
        }
        
       .neo-input {
            border: 3px solid black;
            box-shadow: 4px 4px 0px 0px black;
            font-weight: bold;
        }
       .neo-input:focus {
            outline: none;
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px 0px black;
        }

       .neo-btn {
            border: 3px solid black;
            font-family: 'Archivo Black', sans-serif;
            text-transform: uppercase;
            box-shadow: 4px 4px 0px 0px black;
            transition: all 0.1s;
            cursor: pointer;
        }
       .neo-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px 0px black;
        }
       .neo-btn:active {
            transform: translate(2px, 2px);
            box-shadow: 0px 0px 0px 0px black;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #121212; }
        ::-webkit-scrollbar-thumb { background: #ec4899; border: 2px solid black; }

        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px;
            border: 3px solid black; background: #ec4899;
            cursor: pointer; margin-top: -10px; box-shadow: 2px 2px 0px 0px black;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 8px; cursor: pointer; background: white; border: 2px solid black;
        }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
       .glitch-wrapper { position: relative; }
       .glitch-wrapper::before { content: "ANIME.STACK"; position: absolute; top: 0; left: 3px; color: #ec4899; z-index: -1; mix-blend-mode: multiply; }
       .glitch-wrapper::after { content: "ANIME.STACK"; position: absolute; top: 0; left: -3px; color: #06b6d4; z-index: -2; mix-blend-mode: multiply; }

       .loader {
            width: 24px; height: 24px; border: 4px solid #000; border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-enter { animation: slideUp 0.3s ease-out forwards; }
    </style>
</head>
<body class="font-body text-neo-black min-h-screen p-4 md:p-8 flex flex-col items-center">

    <nav class="w-full max-w-7xl mb-12 flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="neo-box px-4 py-2 bg-white -rotate-2">
            <h1 class="text-3xl md:text-5xl font-display tracking-tighter italic glitch-wrapper">ANIME.STACK</h1>
        </div>
        <div class="flex gap-4">
            <div class="neo-box px-3 py-1 bg-cyan-300 text-xs font-bold uppercase border-2 shadow-neo">v3.2</div>
            <div class="neo-box px-3 py-1 bg-green-300 text-xs font-bold uppercase border-2 shadow-neo">SYSTEM: ONLINE</div>
        </div>
    </nav>

    <main class="w-full max-w-7xl grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
        
        <!-- ================= LEFT COLUMN: STACK BUILDER (4 Cols) ================= -->
        <div class="lg:col-span-4 flex flex-col gap-6">
            
            <!-- SEARCH MODULE -->
            <div class="neo-box p-4 bg-white relative z-20">
                <div class="bg-black text-white px-2 py-1 text-xs font-bold font-mono inline-block mb-2 transform -rotate-1">STEP 1: ADD SEASONS</div>
                <div class="relative group">
                    <input type="text" id="search-input" 
                        class="neo-input w-full p-3 text-lg bg-yellow-50 placeholder-gray-500 uppercase" 
                        placeholder="SEARCH ANIME..." autocomplete="off">
                    <div id="loader" class="absolute right-3 top-3 hidden"><span class="loader"></span></div>
                </div>
                <!-- Dropdown Results -->
                <div id="search-results" class="hidden mt-3 space-y-2 max-h-80 overflow-y-auto pr-1"></div>
            </div>

            <!-- PLAYLIST STACK -->
            <div class="neo-box p-0 bg-white min-h-[300px] flex flex-col relative overflow-hidden">
                <div class="bg-neo-purple border-b-3 border-black p-3 flex justify-between items-center">
                    <h2 class="font-display text-white text-xl uppercase">Your Stack</h2>
                    <span id="stack-count" class="bg-black text-white text-sm font-bold px-2 py-0.5 border-2 border-white">0</span>
                </div>
                
                <div id="playlist-container" class="p-4 space-y-3 flex-1 overflow-y-auto max-h-[500px]">
                    <div id="empty-state" class="text-center py-10 opacity-50">
                        <i class="fas fa-layer-group text-4xl mb-2"></i>
                        <p class="font-bold text-sm uppercase">Stack is Empty</p>
                    </div>
                </div>

                <div class="border-t-3 border-black p-4 bg-neo-yellow flex justify-between items-center">
                    <span class="font-bold uppercase text-sm">Total Episodes</span>
                    <span class="font-display text-2xl" id="global-total-display">0</span>
                </div>
            </div>
        </div>

        <!-- ================= RIGHT COLUMN: DASHBOARD (8 Cols) ================= -->
        <div class="lg:col-span-8 flex flex-col gap-6 relative">
            
            <div id="calc-overlay" class="absolute inset-0 z-30 bg-white/60 backdrop-blur-sm flex items-center justify-center border-3 border-black shadow-neo-deep">
                <div class="bg-black text-white p-6 border-4 border-neo-pink transform -rotate-3 text-center shadow-neo">
                    <h2 class="text-3xl font-display text-neo-yellow mb-2">SYSTEM LOCKED</h2>
                    <p class="font-mono text-sm uppercase">Add at least one anime to the stack<br>to initiate calculation protocol.</p>
                </div>
            </div>

            <div id="calculator-panel" class="neo-box bg-white p-6 md:p-8 transition-opacity duration-300">
                
                <div class="flex justify-between items-start mb-8 border-b-4 border-black pb-4">
                    <div>
                        <h3 class="font-display text-3xl md:text-4xl uppercase leading-none">Progress<br>Tracking</h3>
                    </div>
                    <div class="text-right">
                        <div class="bg-black text-white text-xs font-mono px-2 py-1 inline-block mb-1">GLOBAL EPISODE</div>
                        <div class="relative inline-block">
                            <input type="number" id="global-ep-input" value="0" min="0" 
                                class="text-5xl md:text-6xl font-display text-neo-pink bg-transparent w-48 text-right focus:outline-none placeholder-neo-pink">
                            <i class="fas fa-pen absolute top-2 left-0 text-gray-300 text-xs opacity-50"></i>
                        </div>
                    </div>
                </div>

                <div class="mb-8">
                    <div class="flex justify-between text-xs font-bold font-mono mb-1">
                        <span>START</span>
                        <span id="progress-percent">0%</span>
                        <span>FINISH</span>
                    </div>
                    <div class="h-8 w-full border-3 border-black bg-gray-200 relative">
                        <div id="progress-bar" class="h-full bg-neo-green border-r-3 border-black transition-all duration-500 w-0 relative overflow-hidden">
                            <div class="absolute inset-0 w-full h-full" style="background-image: linear-gradient(45deg,rgba(0,0,0,.1) 25%,transparent 25%,transparent 50%,rgba(0,0,0,.1) 50%,rgba(0,0,0,.1) 75%,transparent 75%,transparent); background-size: 10px 10px;"></div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-neo-bg border-3 border-black p-4 relative">
                        <span class="absolute -top-3 left-4 bg-neo-blue text-white text-xs font-bold px-2 border-2 border-black uppercase">Daily Pace</span>
                        <div class="flex items-center justify-between mt-2">
                            <input type="range" id="pace-slider" min="1" max="24" value="3" class="w-2/3">
                            <div class="font-display text-3xl ml-4" id="pace-display">3</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="border-3 border-black p-2 flex flex-col items-center justify-center cursor-pointer hover:bg-red-50 transition group" onclick="document.getElementById('filler-toggle').click()">
                            <span class="text-xs font-bold uppercase mb-2 group-hover:text-red-500">Skip Fillers</span>
                            <div class="relative">
                                <input type="checkbox" id="filler-toggle" class="peer sr-only">
                                <div class="w-12 h-6 bg-gray-300 border-2 border-black peer-checked:bg-neo-pink transition-all"></div>
                                <div class="absolute left-0 top-0 w-5 h-6 bg-white border-2 border-black transition-all peer-checked:left-6"></div>
                            </div>
                        </div>
                        
                        <div class="border-3 border-black p-2 flex flex-col items-center justify-center cursor-pointer hover:bg-yellow-50 transition group" onclick="document.getElementById('op-toggle').click()">
                            <span class="text-xs font-bold uppercase mb-2 group-hover:text-yellow-600">Speedrun</span>
                            <div class="relative">
                                <input type="checkbox" id="op-toggle" class="peer sr-only">
                                <div class="w-12 h-6 bg-gray-300 border-2 border-black peer-checked:bg-neo-yellow transition-all"></div>
                                <div class="absolute left-0 top-0 w-5 h-6 bg-white border-2 border-black transition-all peer-checked:left-6"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-3 gap-0 border-3 border-black bg-black text-white">
                    <div class="p-6 border-b-2 md:border-b-0 md:border-r-2 border-gray-800 text-center">
                        <p class="text-gray-500 text-xs font-mono mb-1">REMAINING</p>
                        <p class="text-4xl lg:text-5xl font-display text-neo-pink" id="stat-remaining">0</p>
                        <p class="text-xs font-bold uppercase">Episodes</p>
                    </div>
                    <div class="p-6 border-b-2 md:border-b-0 md:border-r-2 border-gray-800 text-center">
                        <p class="text-gray-500 text-xs font-mono mb-1">TIME COST</p>
                        <p class="text-4xl lg:text-5xl font-display text-neo-blue" id="stat-hours">0</p>
                        <p class="text-xs font-bold uppercase">Hours</p>
                    </div>
                    <div class="col-span-2 md:col-span-1 p-6 text-center flex flex-col justify-center bg-gray-900 relative overflow-hidden">
                        <p class="text-gray-500 text-xs font-mono mb-1">FINISH DATE</p>
                        <p class="text-2xl lg:text-3xl font-display text-neo-yellow" id="stat-date">...</p>
                        <div id="stat-saved" class="hidden absolute bottom-0 left-0 w-full bg-green-500 text-black text-[10px] font-bold py-1 uppercase tracking-widest">
                            Saved time active
                        </div>
                    </div>
                </div>

            </div>
            
            <div class="neo-box p-4 bg-yellow-100 flex gap-4 items-center">
                <div class="bg-black text-white w-10 h-10 flex items-center justify-center font-display text-xl shrink-0">?</div>
                <div>
                    <h4 class="font-bold text-sm uppercase">Stack Logic</h4>
                    <p class="text-xs leading-relaxed">Search for individual seasons (e.g. "AoT Season 1", then "Season 2"). Add them in order. The calculator will combine them into one massive timeline.</p>
                </div>
            </div>

        </div>
    </main>

    <footer class="mt-16 mb-8 text-center opacity-60 font-mono text-xs">
        <p>NEO-BRUTALISM UI • JIKAN API • ANIME.STACK v3.2</p>
    </footer>

    <script>
        // --- DATA & STATE ---
        let playlist = []; 
        
        const FILLER_DB = {
            'One Piece': [[54,61], [98,99], [131,143], [196,206], [220,225], [279,283], [326,336], [382,384], [406,407], [426,429], [457,458], [575,578], [626,628], [747,750], [780,782], [895,896], [1029,1030]],
            'Naruto': [[26,26], [97,97], [101,106], [136,140], [143,219]],
            'Naruto: Shippuuden': [[28,28], [57,71], [90,112], [144,151], [170,171], [176,196], [223,242], [257,260], [271,271], [279,281], [284,289], [290,295], [303,320], [347,361], [376,377], [388,390], [394,413], [416,416], [422,423], [427,450], [464,469], [480,483]],
            'Bleach': [[33,33], [50,50], [64,109], [128,137], [168,189], [204,205], [213,214], [227,266], [287,287], [298,299], [303,305], [311,342], [355,355]]
        };

        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        const playlistContainer = document.getElementById('playlist-container');
        const emptyState = document.getElementById('empty-state');
        const globalTotalDisplay = document.getElementById('global-total-display');
        const stackCount = document.getElementById('stack-count');
        const loader = document.getElementById('loader');
        
        const calcOverlay = document.getElementById('calc-overlay');
        const globalEpInput = document.getElementById('global-ep-input');
        const paceSlider = document.getElementById('pace-slider');
        const fillerToggle = document.getElementById('filler-toggle');
        const opToggle = document.getElementById('op-toggle');

        let debounceTimer;
        searchInput.addEventListener('input', (e) => {
            clearTimeout(debounceTimer);
            const query = e.target.value;
            if (query.length < 3) {
                searchResults.classList.add('hidden');
                return;
            }
            loader.classList.remove('hidden');
            debounceTimer = setTimeout(() => fetchAnime(query), 600);
        });

        // --- FETCH FIX: order_by=members to get popular stuff first ---
        async function fetchAnime(query) {
            try {
                const response = await fetch(`https://api.jikan.moe/v4/anime?q=${query}&order_by=members&sort=desc&limit=10`);
                const data = await response.json();
                renderSearchResults(data.data);
            } catch (error) {
                console.error(error);
            } finally {
                loader.classList.add('hidden');
            }
        }

        function renderSearchResults(animes) {
            searchResults.innerHTML = '';
            if(!animes.length) {
                searchResults.classList.add('hidden');
                return;
            }
            searchResults.classList.remove('hidden');

            animes.forEach(anime => {
                const year = anime.year || (anime.aired?.from ? anime.aired.from.substring(0,4) : 'N/A');
                const eps = anime.episodes || 12;

                const div = document.createElement('div');
                div.className = 'flex items-center gap-3 p-3 border-3 border-black bg-white hover:bg-neo-pink hover:text-white cursor-pointer transition mb-2 shadow-neo-hover active:translate-y-1 active:shadow-none';
                div.innerHTML = `
                    <img src="${anime.images.jpg.small_image_url}" class="w-10 h-12 object-cover border-2 border-black bg-gray-200">
                    <div class="flex-1 overflow-hidden">
                        <div class="font-bold text-sm uppercase truncate font-display tracking-tight">${anime.title}</div>
                        <div class="text-[10px] font-mono">${anime.type} • ${year} • ${eps} EPS</div>
                    </div>
                    <div class="bg-black text-white w-8 h-8 flex items-center justify-center font-bold border-2 border-white">
                        <i class="fas fa-plus"></i>
                    </div>
                `;
                div.onclick = () => addToPlaylist(anime);
                searchResults.appendChild(div);
            });
        }

        function addToPlaylist(anime) {
            let fillers = [];
            const commonName = Object.keys(FILLER_DB).find(key => anime.title.includes(key));
            if(commonName) fillers = FILLER_DB[commonName];

            const item = {
                id: anime.mal_id,
                title: anime.title,
                eps: anime.episodes || 12,
                image: anime.images.jpg.small_image_url,
                fillers: fillers
            };

            playlist.push(item);
            
            searchInput.value = '';
            searchResults.classList.add('hidden');
            
            updatePlaylistUI();
        }

        function removeFromPlaylist(index) {
            playlist.splice(index, 1);
            updatePlaylistUI();
        }

        function updatePlaylistUI() {
            playlistContainer.innerHTML = '';
            
            if (playlist.length === 0) {
                emptyState.classList.remove('hidden');
                stackCount.innerText = '0';
                globalTotalDisplay.innerText = '0';
                calcOverlay.classList.remove('hidden');
                return;
            }

            calcOverlay.classList.add('hidden');
            emptyState.classList.add('hidden');
            stackCount.innerText = playlist.length;

            let cumulativeTotal = 0;

            playlist.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-2 bg-white p-2 border-3 border-black shadow-neo-hover animate-enter group';
                div.innerHTML = `
                    <div class="bg-black text-white text-xs font-bold w-6 h-6 flex items-center justify-center shrink-0">${index + 1}</div>
                    <img src="${item.image}" class="w-10 h-10 object-cover border-2 border-black shrink-0">
                    <div class="flex-1 min-w-0">
                        <div class="text-xs font-bold uppercase truncate font-body">${item.title}</div>
                        <div class="text-[10px] font-mono text-gray-600">${item.eps} EPS ${item.fillers.length ? '<span class="text-neo-green font-bold text-shadow-sm ml-1">★ FILLER DB</span>' : ''}</div>
                    </div>
                    <button onclick="removeFromPlaylist(${index})" class="bg-red-500 text-white w-8 h-8 border-2 border-black flex items-center justify-center hover:bg-red-600 transition">
                        <i class="fas fa-trash-alt text-xs"></i>
                    </button>
                `;
                playlistContainer.appendChild(div);
                cumulativeTotal += item.eps;
            });

            globalTotalDisplay.innerText = cumulativeTotal;
            if(parseInt(globalEpInput.value) > cumulativeTotal) globalEpInput.value = cumulativeTotal;

            calculate();
        }

        function calculate() {
            if (playlist.length === 0) return;

            const globalCurrentEp = parseInt(globalEpInput.value) || 0;
            const pace = parseInt(paceSlider.value);
            const skipFillers = fillerToggle.checked;
            const minutesPerEp = opToggle.checked ? 20 : 24;

            const totalStackEps = playlist.reduce((acc, item) => acc + item.eps, 0);
            
            if (globalCurrentEp > totalStackEps) {
                globalEpInput.value = totalStackEps;
                return calculate();
            }

            let remainingEpsToWatch = 0;
            let fillersSkipped = 0;
            let tempEpisodeCounter = 0;

            playlist.forEach(season => {
                const seasonStart = tempEpisodeCounter + 1;
                const seasonEnd = tempEpisodeCounter + season.eps;

                if (globalCurrentEp >= seasonEnd) {
                    tempEpisodeCounter += season.eps;
                    return;
                }

                let startCheck = Math.max(1, globalCurrentEp - tempEpisodeCounter + 1);
                
                for (let ep = startCheck; ep <= season.eps; ep++) {
                    let isFiller = false;
                    if (season.fillers.length > 0) {
                        isFiller = season.fillers.some(range => ep >= range[0] && ep <= range[1]);
                    }

                    if (skipFillers && isFiller) {
                        fillersSkipped++;
                    } else {
                        remainingEpsToWatch++;
                    }
                }
                
                tempEpisodeCounter += season.eps;
            });

            const totalHours = Math.floor((remainingEpsToWatch * minutesPerEp) / 60);
            const daysLeft = Math.ceil(remainingEpsToWatch / pace);
            
            const date = new Date();
            date.setDate(date.getDate() + daysLeft);
            const dateStr = remainingEpsToWatch === 0 ? "DONE" : date.toLocaleDateString('pt-BR', {day:'numeric', month:'short'}).toUpperCase();

            const percent = totalStackEps > 0 ? Math.min(100, Math.round((globalCurrentEp / totalStackEps) * 100)) : 0;
            document.getElementById('progress-bar').style.width = `${percent}%`;
            document.getElementById('progress-percent').innerText = `${percent}%`;

            document.getElementById('stat-remaining').innerText = remainingEpsToWatch;
            document.getElementById('stat-hours').innerText = totalHours;
            document.getElementById('stat-date').innerText = dateStr;
            document.getElementById('pace-display').innerText = pace;

            const savedEl = document.getElementById('stat-saved');
            if (fillersSkipped > 0) {
                const savedHrs = ((fillersSkipped * minutesPerEp) / 60).toFixed(1);
                savedEl.innerText = `SAVED ${savedHrs} HOURS SKIPPING FILLERS`;
                savedEl.classList.remove('hidden');
            } else {
                savedEl.classList.add('hidden');
            }
        }

        globalEpInput.addEventListener('input', calculate);
        paceSlider.addEventListener('input', (e) => {
            document.getElementById('pace-display').innerText = e.target.value;
            calculate();
        });
        fillerToggle.addEventListener('change', calculate);
        opToggle.addEventListener('change', calculate);

    </script>
</body>
</html>